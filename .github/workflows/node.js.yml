# This workflow builds, tests, and publishes Conso to NPM when a release is published
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Build & Publish

on:
  release:
    types: [published]

permissions:
  contents: write
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: "publish-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  build-and-publish:
    name: Build, Test & Publish
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
      
      - name: Verify version matches tag
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch: package.json ($PACKAGE_VERSION) != tag ($TAG_VERSION)"
            exit 1
          fi
          echo "âœ… Version verified: $PACKAGE_VERSION"
      
      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: node_modules/.cache/turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            turbo-${{ runner.os }}-
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint code
        run: npm run lint --if-present
        continue-on-error: false
      
      - name: Build packages
        run: npm run build
      
      - name: Run tests
        run: npm test
        env:
          CI: true
      
      - name: Check package contents
        run: |
          npm pack --dry-run
          echo "âœ… Package validation successful"
      
      - name: Publish to NPM
        run: |
          npm publish --access public --provenance
          echo "âœ… Published to NPM successfully"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Wait for NPM propagation
        run: |
          echo "â³ Waiting for NPM registry propagation..."
          sleep 30
      
      - name: Verify NPM publication
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if npm view conso@$PACKAGE_VERSION version > /dev/null 2>&1; then
              echo "âœ… Package conso@$PACKAGE_VERSION is available on NPM"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES: Package not yet available, waiting..."
            sleep 10
          done
          
          echo "âš ï¸ Could not verify package on NPM after $MAX_RETRIES attempts"
          exit 1
      
      - name: Deploy Documentation
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          publish_dir: ./apps/docs/out
          cname: docs.yourproject.com  # Optional: Add your custom domain
          commit_message: "docs: deploy ${{ github.event.release.tag_name }}"
      
      - name: Create Release Summary
        if: success()
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Release Published Successfully!
          
          **Version:** \`${{ github.event.release.tag_name }}\`  
          **Package:** \`conso@${PACKAGE_VERSION}\`  
          **Registry:** [View on NPM](https://www.npmjs.com/package/conso/v/${PACKAGE_VERSION})  
          **Release:** [View Release](${{ github.event.release.html_url }})
          
          ### âœ… Completed Tasks
          
          - âœ“ Code checkout and validation
          - âœ“ Dependencies installed
          - âœ“ Linting passed
          - âœ“ Build successful
          - âœ“ Tests passed
          - âœ“ Package published to NPM
          - âœ“ Documentation deployed to GitHub Pages
          
          ### ðŸ“¦ Installation
          
          \`\`\`bash
          npm install conso@${PACKAGE_VERSION}
          \`\`\`
          
          ---
          
          ðŸŒ **Converso Empire** - Empire of Innovation, Creativity & Intelligence
          EOF
      
      - name: Notify on failure
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âŒ Release Failed
          
          The release process encountered an error. Please review the logs above.
          
          ### ðŸ” Troubleshooting Guide
          
          **Authentication Issues:**
          - Verify `NPM_TOKEN` secret is set and valid
          - Check token has publish permissions
          - Ensure token hasn't expired
          
          **Version Conflicts:**
          - Version already exists on NPM (republishing same version not allowed)
          - package.json version doesn't match git tag
          
          **Build/Test Failures:**
          - Check for failing tests in the logs
          - Review build errors
          - Verify all dependencies are compatible
          
          **Dependency Issues:**
          - package-lock.json may be out of sync
          - Run `npm install` locally and commit changes
          
          **Documentation Deployment:**
          - Verify `ACTIONS_DEPLOY_KEY` is configured
          - Check docs build output exists at `./apps/docs/out`
          
          ### ðŸ› ï¸ Next Steps
          
          1. Review the failed step in the workflow logs
          2. Fix the issue locally
          3. Create a new release with incremented version
          EOF
      
      - name: Comment on Release
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const version = require('./package.json').version;
            await github.rest.repos.createReleaseComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: `âœ… Successfully published \`conso@${version}\` to NPM!\n\nðŸ“¦ Install: \`npm install conso@${version}\``
            });